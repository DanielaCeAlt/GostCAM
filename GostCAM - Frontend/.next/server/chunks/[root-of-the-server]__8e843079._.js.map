{"version":3,"sources":["turbopack:///[project]/src/lib/database.ts"],"sourcesContent":["// =============================================\r\n// CONFIGURACIÓN DE BASE DE DATOS MYSQL\r\n// =============================================\r\n\r\nimport mysql from 'mysql2/promise';\r\nimport { VistaEquipoCompleto, VistaMovimientoDetallado } from '@/types/database';\r\n\r\n// Configuración de la conexión a la base de datos\r\nconst dbConfig = {\r\n  host: process.env.DB_HOST || 'localhost',\r\n  port: parseInt(process.env.DB_PORT || '3306'),\r\n  user: process.env.DB_USER || 'root',\r\n  password: process.env.DB_PASSWORD || '',\r\n  database: process.env.DB_NAME || 'GostCAM',\r\n  charset: 'utf8mb4',\r\n  timezone: '+00:00',\r\n};\r\n\r\n// Pool de conexiones para mejor performance\r\nconst pool = mysql.createPool({\r\n  ...dbConfig,\r\n  waitForConnections: true,\r\n  connectionLimit: 10,\r\n  queueLimit: 0,\r\n});\r\n\r\n// Función para obtener una conexión del pool\r\nexport const getConnection = async () => {\r\n  try {\r\n    const connection = await pool.getConnection();\r\n    return connection;\r\n  } catch (error) {\r\n    console.error('Error connecting to the database:', error);\r\n    throw new Error('Failed to connect to database');\r\n  }\r\n};\r\n\r\n// Función para ejecutar queries con manejo de errores\r\nexport const executeQuery = async <T = Record<string, unknown>>(\r\n  query: string,\r\n  params: (string | number | Date | null | undefined)[] = []\r\n): Promise<T[]> => {\r\n  let connection;\r\n  try {\r\n    connection = await getConnection();\r\n    const [rows] = await connection.execute(query, params);\r\n    return rows as T[];\r\n  } catch (error) {\r\n    console.error('Database query error:', error);\r\n    console.error('Query:', query);\r\n    console.error('Params:', params);\r\n    throw error;\r\n  } finally {\r\n    if (connection) {\r\n      connection.release();\r\n    }\r\n  }\r\n};\r\n\r\n// Función para ejecutar procedimientos almacenados\r\nexport const callStoredProcedure = async <T = Record<string, unknown>>(\r\n  procedureName: string,\r\n  params: (string | number | Date | null | undefined)[] = []\r\n): Promise<T[]> => {\r\n  const placeholders = params.map(() => '?').join(', ');\r\n  const query = `CALL ${procedureName}(${placeholders})`;\r\n  \r\n  let connection;\r\n  try {\r\n    connection = await getConnection();\r\n    const [rows] = await connection.execute(query, params);\r\n    // Los procedimientos almacenados devuelven arrays anidados\r\n    return Array.isArray(rows) && Array.isArray(rows[0]) ? rows[0] as T[] : rows as T[];\r\n  } catch (error) {\r\n    console.error('Stored procedure error:', error);\r\n    console.error('Procedure:', procedureName);\r\n    console.error('Params:', params);\r\n    throw error;\r\n  } finally {\r\n    if (connection) {\r\n      connection.release();\r\n    }\r\n  }\r\n};\r\n\r\n// Función para verificar la conexión a la base de datos\r\nexport const testConnection = async (): Promise<boolean> => {\r\n  try {\r\n    const result = await executeQuery('SELECT 1 as test');\r\n    return result.length > 0;\r\n  } catch (error) {\r\n    console.error('Database connection test failed:', error);\r\n    return false;\r\n  }\r\n};\r\n\r\n// Función para cerrar el pool de conexiones\r\nexport const closePool = async (): Promise<void> => {\r\n  try {\r\n    await pool.end();\r\n    console.log('Database pool closed');\r\n  } catch (error) {\r\n    console.error('Error closing database pool:', error);\r\n  }\r\n};\r\n\r\n// Funciones específicas para las vistas de GostCAM\r\nexport const getEquiposCompletos = async (filters?: {\r\n  sucursal?: string;\r\n  tipoEquipo?: string;\r\n  estatus?: string;\r\n  usuario?: string;\r\n  busqueda?: string;\r\n}): Promise<VistaEquipoCompleto[]> => {\r\n  // Usar directamente la tabla equipo con una consulta simple\r\n  return getEquiposFromTable(filters);\r\n};\r\n\r\n// Función fallback para consultar tabla equipos directamente\r\nconst getEquiposFromTable = async (filters?: {\r\n  sucursal?: string;\r\n  tipoEquipo?: string;\r\n  estatus?: string;\r\n  usuario?: string;\r\n  busqueda?: string;\r\n}): Promise<VistaEquipoCompleto[]> => {\r\n  let query = `\r\n    SELECT \r\n      e.no_serie,\r\n      e.nombreEquipo,\r\n      e.numeroActivo,\r\n      e.modelo,\r\n      e.fechaAlta,\r\n      e.idPosicion,\r\n      te.nombreTipo as TipoEquipo,\r\n      ee.estatus as EstatusEquipo,\r\n      'Centro Principal' as SucursalActual,\r\n      u.NombreUsuario as UsuarioAsignado\r\n    FROM equipo e\r\n    LEFT JOIN tipoequipo te ON e.idTipoEquipo = te.idTipoEquipo\r\n    LEFT JOIN estatusequipo ee ON e.idEstatus = ee.idEstatus\r\n    LEFT JOIN usuarios u ON e.idUsuarios = u.idUsuarios\r\n  `;\r\n  \r\n  const params: (string | number | Date | null | undefined)[] = [];\r\n  const conditions: string[] = [];\r\n\r\n  // ✅ Filtrar equipos eliminados lógicamente\r\n  conditions.push('(e.eliminado IS NULL OR e.eliminado = 0)');\r\n\r\n  if (filters) {\r\n    if (filters.tipoEquipo) {\r\n      conditions.push('te.nombreTipo = ?');\r\n      params.push(filters.tipoEquipo);\r\n    }\r\n    if (filters.estatus) {\r\n      conditions.push('ee.estatus = ?');\r\n      params.push(filters.estatus);\r\n    }\r\n    if (filters.usuario) {\r\n      conditions.push('u.NombreUsuario LIKE ?');\r\n      params.push(`%${filters.usuario}%`);\r\n    }\r\n    if (filters.busqueda) {\r\n      // Búsqueda global en todos los campos principales (función fallback)\r\n      conditions.push(`(\r\n        e.nombreEquipo LIKE ? OR \r\n        e.no_serie LIKE ? OR \r\n        e.numeroActivo LIKE ? OR\r\n        e.modelo LIKE ? OR\r\n        te.nombreTipo LIKE ? OR\r\n        ee.estatus LIKE ? OR\r\n        u.NombreUsuario LIKE ?\r\n      )`);\r\n      // Repetir el término de búsqueda para cada campo\r\n      const termino = `%${filters.busqueda}%`;\r\n      params.push(termino, termino, termino, termino, termino, termino, termino);\r\n    }\r\n  }\r\n\r\n  if (conditions.length > 0) {\r\n    query += ' WHERE ' + conditions.join(' AND ');\r\n  }\r\n\r\n  query += ' ORDER BY e.fechaAlta DESC';\r\n\r\n  const result = await executeQuery<VistaEquipoCompleto>(query, params);\r\n  \r\n  return result;\r\n};\r\n\r\nexport const getMovimientosDetallados = async (filters?: {\r\n  sucursalOrigen?: string;\r\n  sucursalDestino?: string;\r\n  tipoMovimiento?: string;\r\n  estatusMovimiento?: string;\r\n  fechaDesde?: string;\r\n  fechaHasta?: string;\r\n}): Promise<VistaMovimientoDetallado[]> => {\r\n  let query = 'SELECT * FROM VistaMovimientosDetallados';\r\n  const params: (string | number | Date | null | undefined)[] = [];\r\n  const conditions: string[] = [];\r\n\r\n  if (filters) {\r\n    if (filters.sucursalOrigen) {\r\n      conditions.push('SucursalOrigen = ?');\r\n      params.push(filters.sucursalOrigen);\r\n    }\r\n    if (filters.sucursalDestino) {\r\n      conditions.push('SucursalDestino = ?');\r\n      params.push(filters.sucursalDestino);\r\n    }\r\n    if (filters.tipoMovimiento) {\r\n      conditions.push('tipoMovimiento = ?');\r\n      params.push(filters.tipoMovimiento);\r\n    }\r\n    if (filters.estatusMovimiento) {\r\n      conditions.push('estatusMovimiento = ?');\r\n      params.push(filters.estatusMovimiento);\r\n    }\r\n    if (filters.fechaDesde) {\r\n      conditions.push('fecha >= ?');\r\n      params.push(filters.fechaDesde);\r\n    }\r\n    if (filters.fechaHasta) {\r\n      conditions.push('fecha <= ?');\r\n      params.push(filters.fechaHasta);\r\n    }\r\n  }\r\n\r\n  if (conditions.length > 0) {\r\n    query += ' WHERE ' + conditions.join(' AND ');\r\n  }\r\n\r\n  query += ' ORDER BY fecha DESC';\r\n\r\n  return executeQuery<VistaMovimientoDetallado>(query, params);\r\n};\r\n\r\nexport const getInventarioPorEstatus = async () => {\r\n  return executeQuery('SELECT * FROM VistaInventarioPorEstatus ORDER BY estatus, TipoEquipo');\r\n};\r\n\r\n// Función para obtener todos los catálogos del sistema\r\nexport const getCatalogos = async () => {\r\n  try {\r\n    console.log('Obteniendo catálogos...');\r\n    \r\n    // Función auxiliar para ejecutar consultas con fallback\r\n    const executeWithFallback = async (query: string, fallback: any[] = []) => {\r\n      try {\r\n        return await executeQuery(query);\r\n      } catch (error) {\r\n        console.warn(`Query failed: ${query}`, error);\r\n        return fallback;\r\n      }\r\n    };\r\n\r\n    // Obtener catálogos básicos que probablemente existan\r\n    const usuarios = await executeWithFallback('SELECT * FROM usuarios', []);\r\n    \r\n    // Para tipos de equipo, intentar múltiples variantes\r\n    const tiposEquipo = await executeWithFallback('SELECT * FROM tipoequipo', []);\r\n    \r\n    // Para estatus, intentar múltiples variantes  \r\n    const estatusEquipos = await executeWithFallback('SELECT * FROM estatusequipo', []);\r\n    \r\n    // Para posiciones, usar valores por defecto si no existe\r\n    const posiciones = await executeWithFallback('SELECT * FROM posiciones', [\r\n      { id: 1, nombre: 'Entrada Principal' },\r\n      { id: 2, nombre: 'Recepción' },\r\n      { id: 3, nombre: 'Oficina' }\r\n    ]);\r\n\r\n    // Para sucursales, intentar obtener de la tabla de equipos o crear por defecto\r\n    const sucursales = await executeWithFallback('SELECT DISTINCT SucursalActual as nombre, SucursalActual as id FROM equipos WHERE SucursalActual IS NOT NULL AND SucursalActual != \"\"', [\r\n      { id: 'SUC001', nombre: 'Sucursal Principal' },\r\n      { id: 'SUC002', nombre: 'Sucursal Norte' },\r\n      { id: 'SUC003', nombre: 'Sucursal Sur' }\r\n    ]);\r\n\r\n    return {\r\n      tiposEquipo,\r\n      estatusEquipos,\r\n      usuarios,\r\n      posiciones,\r\n      sucursales,\r\n      // Catálogos adicionales vacíos por ahora\r\n      estados: [],\r\n      municipios: [],\r\n      zonas: []\r\n    };\r\n  } catch (error) {\r\n    console.error('Error obteniendo catálogos:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\nexport const getHistorialMovimientos = async (no_serie?: string) => {\r\n  if (no_serie) {\r\n    return executeQuery('SELECT * FROM VistaHistorialMovimientos WHERE no_serie = ? ORDER BY fecha DESC', [no_serie]);\r\n  }\r\n  return executeQuery('SELECT * FROM VistaHistorialMovimientos ORDER BY fecha DESC LIMIT 100');\r\n};\r\n\r\n\r\nexport default pool;"],"names":[],"mappings":"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"}